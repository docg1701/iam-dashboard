# Story 1.5: User Account Management

## Status
Approved

## Story
**As a** sysadmin,  
**I want** to create and manage user accounts with different permission levels,  
**so that** I can control system access and maintain proper security boundaries.

## Acceptance Criteria

1. **User Management API:** CRUD endpoints for user account creation, modification, and deactivation
2. **Role Assignment:** Ability to assign and modify user roles (sysadmin, admin, user) with proper validation
3. **User Administration UI:** Interface for creating users, setting roles, and managing account status
4. **Permission Enforcement:** Enhanced role-based access control with agent-specific permissions properly enforced
5. **Account Status Management:** Ability to activate, deactivate, and reset user accounts
6. **User List Display:** Comprehensive view of all users with filtering and search capabilities, including permission summaries
7. **Audit Trail:** All user management actions logged with administrator and timestamp details
8. **Password Management:** Secure password reset functionality for administrators

## Tasks / Subtasks

- [ ] Task 1: Create User Management API Endpoints (AC: 1, 2, 4)
  - [ ] Create `apps/api/src/api/v1/users.py` with CRUD endpoints for user management
  - [ ] Implement JWT authentication middleware integration for all endpoints
  - [ ] Add permission validation ensuring only sysadmin/admin can manage users
  - [ ] Create Pydantic request/response schemas for user data validation
  - [ ] Implement user creation with email validation and secure password handling
  - [ ] Add user update functionality with role assignment validation
  - [ ] Implement user deactivation (soft delete) with proper status management

- [ ] Task 2: Create User Service Layer (AC: 1, 4, 7, 8)
  - [ ] Create NEW file `apps/api/src/services/user_service.py` with business logic
  - [ ] Implement user creation with database transaction handling
  - [ ] Add role assignment and validation logic
  - [ ] Integrate audit logging for all user management operations
  - [ ] Implement secure password reset functionality
  - [ ] Add account status management (activate/deactivate)
  - [ ] Implement proper error handling with HTTP status codes

- [ ] Task 3: User Data Models and Schemas (AC: 1, 2)
  - [ ] Verify/enhance `apps/api/src/models/user.py` SQLModel implementation
  - [ ] Create Pydantic schemas for user management in `apps/api/src/schemas/user.py`
  - [ ] Ensure proper relationship definitions with audit trail models
  - [ ] Add validation for email uniqueness and password strength
  - [ ] Implement role enum validation with proper constraints

- [ ] Task 4: User Administration UI Components (AC: 3, 5, 6)
  - [ ] Create `apps/web/src/components/forms/UserForm.tsx` for user creation/editing
  - [ ] Implement `apps/web/src/components/UsersList.tsx` with search and filtering
  - [ ] Add `apps/web/src/components/UserStatusToggle.tsx` for account management
  - [ ] Create role selection component with proper validation
  - [ ] Implement responsive design with shadcn/ui components
  - [ ] Add success feedback and error handling with Portuguese messages

- [ ] Task 5: Frontend API Integration (AC: 3, 6, 8)
  - [ ] Create `apps/web/src/services/users.service.ts` for API communication
  - [ ] Implement TanStack Query integration for user data management
  - [ ] Create `apps/web/src/hooks/useUsers.ts` for user management operations
  - [ ] Add proper error handling and user feedback for API failures
  - [ ] Implement cache invalidation after user operations
  - [ ] Add search and filtering functionality

- [ ] Task 6: Permission Integration (AC: 4)
  - [ ] Integrate with existing permission system from Story 1.3 (JWT authentication middleware and role-based access control are already implemented)
  - [ ] Implement proper permission checks in user management UI
  - [ ] Add permission validation middleware for all user operations
  - [ ] Ensure role-based access control throughout the system
  - [ ] Add permission summaries to user list display

- [ ] Task 7: Comprehensive Testing (AC: All)
  - [ ] Create backend unit tests for user service logic
  - [ ] Add API endpoint integration tests with permission validation
  - [ ] Create frontend component tests using React Testing Library
  - [ ] Add user management workflow tests
  - [ ] Implement role assignment and permission validation tests
  - [ ] Create audit logging validation tests

## Dev Notes

### Architecture Context
This story implements user account management functionality as defined in the IAM Dashboard architecture, building upon the existing authentication system and extending it with comprehensive user administration capabilities.

### Previous Story Insights
From Story 1.3 (Authentication System):
- JWT authentication middleware is implemented and functional
- Permission-based access control is established with role validation
- User model exists with basic authentication fields
- Secure password hashing is configured with bcrypt
- Audit logging infrastructure is in place

From Story 1.4 (Basic Client Registration):
- Service layer patterns are established for business logic
- API endpoint structure follows RESTful conventions
- Frontend components use shadcn/ui with proper validation
- TanStack Query integration is working for API state management
- Audit logging is operational for all operations

### Data Models
**User Model** [Source: architecture/data-models.md#user-model]:
```typescript
interface User {
  id: string;
  email: string;
  role: 'sysadmin' | 'admin' | 'user';
  isActive: boolean;
  totpEnabled: boolean;
  createdAt: string;
  updatedAt: string;
  permissions?: UserAgentPermission[];
}
```

**Database Schema** [Source: architecture/database-schema.md]:
- Table: `users`
- Fields: id (UUID), email (unique), password_hash, role (enum), is_active, totp_secret, timestamps
- Constraints: valid email format, password not empty, role validation
- Indexes: email, role, active status for performance

### API Specifications
**User Management Endpoints** [Source: architecture/api-specification.md]:
- GET `/api/v1/users` - List users with search and filtering
- POST `/api/v1/users` - Create new user account
- PUT `/api/v1/users/{id}` - Update user information and role
- DELETE `/api/v1/users/{id}` - Deactivate user account
- POST `/api/v1/users/{id}/reset-password` - Reset user password
- Authentication: JWT Bearer token required
- Permission: sysadmin or admin role required for all operations
- Content-Type: `application/json`
- Response: Standardized user response schema

### Component Specifications
**User Management Interface** [Source: architecture/components.md]:
- Location: `apps/web/src/components/forms/UserForm.tsx`
- Uses shadcn/ui form components with Tailwind CSS
- Implements role selection with proper validation
- Mobile-responsive design with accessibility support
- Portuguese UI labels with comprehensive error handling

### Project Structure
**Relevant Directory Structure** [Source: architecture/unified-project-structure.md]:
```plaintext
apps/
├── web/                          # Next.js 15 Frontend Application
│   ├── src/
│   │   ├── components/           # Reusable UI components
│   │   │   └── forms/           # Form components (UserForm.tsx)
│   │   ├── hooks/               # Custom React hooks (useUsers.ts)
│   │   ├── services/            # API client services (users.service.ts)
│   │   └── utils/               # Frontend utilities
│   └── tests/                   # Frontend testing
└── api/                         # FastAPI Backend Application
    ├── src/
    │   ├── api/                 # API route controllers
    │   │   └── v1/              # API version 1 (users.py)
    │   ├── services/            # Business logic services (user_service.py)
    │   ├── models/              # SQLModel data models (user.py)
    │   └── schemas/             # Pydantic schemas (user.py)
    └── tests/                   # Backend testing
        ├── unit/                # Unit tests
        └── integration/         # Integration tests
```

### File Locations
**Backend Files** [Source: architecture/unified-project-structure.md]:
- API Route: `apps/api/src/api/v1/users.py`
- Service: `apps/api/src/services/user_service.py`
- Models: `apps/api/src/models/user.py` (enhance existing)
- Schemas: `apps/api/src/schemas/user.py`
- Tests: `apps/api/tests/unit/test_user_service.py`, `apps/api/tests/integration/test_users_api.py`

**Frontend Files** [Source: architecture/unified-project-structure.md]:
- Components: `apps/web/src/components/forms/UserForm.tsx`, `apps/web/src/components/UsersList.tsx`
- Service: `apps/web/src/services/users.service.ts`
- Hooks: `apps/web/src/hooks/useUsers.ts`
- Tests: `apps/web/src/components/forms/__tests__/UserForm.test.tsx`

### Testing Requirements
**Backend Testing** [Source: architecture/testing-strategy.md]:
- Framework: pytest with SQLModel fixtures
- Mock external dependencies only (never internal business logic)
- Unit tests for UserService class methods
- Integration tests for API endpoints with database
- Permission enforcement testing for admin/sysadmin access
- Role assignment validation edge cases

**Frontend Testing** [Source: architecture/testing-strategy.md]:
- Framework: Vitest + React Testing Library
- Component behavior testing (not implementation details)
- Form validation scenarios with role selection
- API integration tests with mocked fetch calls
- Permission-based UI rendering validation
- User management workflow testing

### Technical Constraints
**Role Validation** [Source: architecture/data-models.md]:
- Enum values: 'sysadmin', 'admin', 'user'
- Only sysadmin can create other sysadmin accounts
- Admin can create admin and user accounts
- Proper validation in both frontend and backend

**Security Requirements** [Source: architecture/security-and-performance.md]:
- Input sanitization for all user data fields
- Secure password handling with bcrypt hashing
- Email validation and uniqueness enforcement
- Permission-based access control for all operations
- Audit logging for compliance and security tracking

**Permission Enforcement** [Source: architecture/coding-standards.md]:
- All user management operations require admin or sysadmin role
- UI components must use centralized permission checking
- API endpoints must validate permissions before operations
- Proper error responses for insufficient permissions

### Testing

**Test File Locations** [Source: architecture/testing-strategy.md#test-organization]:
- Backend Unit: `apps/api/tests/unit/test_user_service.py` (NEW FILE)
- Backend Integration: `apps/api/tests/integration/test_users_api.py` (NEW FILE)
- Frontend Component: `apps/web/src/components/forms/__tests__/UserForm.test.tsx` (NEW FILE)
- Frontend Utils: `apps/web/src/services/__tests__/users.service.test.ts` (NEW FILE)

**Testing Standards** [Source: architecture/testing-strategy.md]:
- 80%+ code coverage required
- Mock only external dependencies (APIs, time, UUID generation)
- Never mock internal business logic or components
- Test both success and error scenarios comprehensively
- Validate permission enforcement at API and UI levels

**Testing Frameworks** [Source: architecture/testing-strategy.md]:
- Backend: pytest with SQLModel test database fixtures
- Frontend: Vitest with React Testing Library for component testing
- E2E: MCP Playwright for full workflow testing
- Coverage: Built-in coverage tools for both frontend and backend

**Specific Testing Requirements for This Story**:
- Role assignment validation with different user types
- Permission enforcement testing for admin/sysadmin operations
- User creation, update, and deactivation workflows
- Email validation and uniqueness constraints
- Password reset functionality security validation
- Error handling for invalid operations and insufficient permissions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-15 | 1.0 | Initial story creation from Epic 1 requirements | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

*This section will be populated by the QA agent during review*